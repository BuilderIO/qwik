# Refactoring

- move SW from QwikCity to Qwik. This move is needed because:
  - MFE require that one SW can handle multiple requests.
  - Astro needs SW (but because astro replaces QwikCity SW it can't be used)
  - NextJS needs SW (but because nextjs replaces QwikCity SW it can't be used)

# Problems to solve
- [X] Move SW from QwikCity to Qwik
- [X] One SW can get fetch instructions from multiple containers. 
- [X] QwikCity still needs to be able to push information per route to the SW.
  - Right now the route information to the SW is global, the prefetch instructions should be included per route navigation.
- [X] Build system needs to generate `q-bundle-graph-HASH.json` and place it in the `dist/build` folder.
- [X] Build system needs to generate `qwik-prefetch-service-worker.js`.
- [ ] Send `qprefetch` requests to SW.
- [ ] Qwik server needs to collect bundles and emit `qwikPrefetchSW.push(['prefetch', a.js, b.j, ...])`

  # BRAINSTORMING

  ## How does SW get the data
  - SW has full knowledge of the app
    - CURRENT: Bundle/Route data is inlined into SW.
    - Bundle/Route data can be fetched by SW from URL
      - CON: extra round trip
    - Bundle/Route data is sent to SW as a event from HTML
      - CON: Makes HTML larger
  - SW has partial knowledge as the application runs.
    - PREFERRED: partial Bundle/Route data is inlined into HTML and sent to SW as a post msg.


  1. Have generic `qwik-sw-loader.js` service worker (Shared across all MFEs)
  2. Qwik generates `qwik-sw-HASH.js` which contains the BundleGraph and send it to `qwik-sw-loader.js`
  3. QwikCity generates `qwik-city-sw-HASH.js` which contains the RouteGraph and send it to `qwik-sw-loader.js`


  All microfrontends share a qwikLoader, we now make a service worker that everybody shares.
  
  BUT every container makes its own service worker that contains the BundleGraph
  
  Then qwik city can make another service worker that contains the RouteGraph
  
  Service workers communicate with others to get the info, the main one collects everything.

  Qwik generates service worker with the payload of application. Qwik city generates another graph

  Astro integration would be missing the route information. We can fix this (if the consumer has it enabled) with insights.