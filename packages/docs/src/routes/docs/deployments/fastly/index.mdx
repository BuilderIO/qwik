---
title: Fastly Adapter and Middleware | Deployments
contributors:
  - kalebpace
---

# Fastly Adapter

Qwik City Fastly adapter allows you to connect Qwik City to [Fastly's Compute@Edge](https://developer.fastly.com/learning/compute/frameworks/).

## Installation

To integrate the `fastly` adapter, use the `add` command:

```shell
npm run qwik add fastly
```

The adapter will add a new `vite.config.ts` within the `adapters/` directory, and a new entry file will be created, such as:

```shell
└── adapters/
    └── fastly/
        └── vite.config.ts
└── src/
    └── entry.fastly.tsx
```

Additionally, within the `package.json`, the `build.server` and `deploy` scripts will be updated.

## Production build

To build the application for production, use the `build` command, this command will automatically run `npm run build.server` and `npm run build.client`:

```shell
npm run build
```

[Read the full guide here](https://github.com/BuilderIO/qwik/tree/main/starters/adapters/fastly/README.md)

## Deploy to Fastly

After installing the integration using `npm run qwik add fastly`, the project is ready to be deployed to Fastly.

Please refer to the [Fastly docs](https://developer.fastly.com/learning/compute/frameworks/) for more information on how to deploy your site.

Note that you will need a [Fastly account](https://www.fastly.com/signup/) in order to complete this step.

## Advanced

### Fastly Entry Middleware

When the `fastly` adapter is added, a new entry file will be created at `src/entry.fastly.tsx`. Below is an example of using the built-in middleware within the entry file.

```tsx title="src/entry.fastly.tsx"
import {
  createQwikCity,
  type PlatformFastly,
} from '@builder.io/qwik-city/middleware/fastly';
import qwikCityPlan from '@qwik-city-plan';
import { manifest } from '@qwik-client-manifest';
import render from './entry.ssr';

const fetch = createQwikCity({ render, qwikCityPlan, manifest });

export { fetch };
```

The compiled middleware will be built in the `dist/` directory. This directory also contains an `index.js` file which implements the application's request handling as per the [Fastly ComputeJS Docs](https://developer.fastly.com/learning/compute/javascript/).
The file simply re-exports the produced `fetch` handler and attaches the fastly fetch event listener as shown below. It also uses [@fastly/compute-js-static-publish](https://github.com/fastly/compute-js-static-publish) to configure inlining assets into the WASM or publishing to Fastly KV Store.

```tsx title="/dist/index.js"
// generated by @qwik-city/adapters/fastly
import { fetch } from "../server/entry.fastly";
// inject special static file server to handle publishing assets as bundled wasm or upload to KV Store
import { getServer } from "../src/statics.js";
const staticContentServer = getServer();
addEventListener('fetch', (event) => event.respondWith(fetch(event, staticContentServer)))
```

- [Fastly Middleware Source](https://github.com/BuilderIO/qwik/tree/main/packages/qwik-city/middleware/fastly/index.ts)

### Context

You may access Fastly's environment variables in the endpoint method's `platform` param:

```ts
export const onRequest = async ({ platform }) => {
  const secret = platform.env['SUPER_SECRET_TOKEN'];
};
```

Additionally, you may import the `RequestHandler` and `PlatformFastly` types to have type completions in your editor.

```tsx
import { type RequestHandler } from '@builder.io/qwik-city';
import { type PlatformFastly } from '@builder.io/qwik-city/middleware/fastly';

export const onGet: RequestHandler<PlatformFastly> = ({ platform }) => {
  //...
};
```
